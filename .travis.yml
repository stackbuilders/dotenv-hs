---
language: haskell

ghc:
  - "8.6"
  - "8.4"
  - "8.2"
  - "8.0"
  - "7.10"

env:
  global:
    - PATH=$HOME/.local/bin:$PATH
    # Envs for OS X
    - GHC_VER="8.6.5"
    - CABAL_VER="2.4.0.0"
    - PATH=$HOME/Library/Python/2.7/bin:$PATH
    - PATH=$HOME/.cabal/bin:$HOME/.ghcup/bin:$PATH
    - PATH=$HOME/.ghcup/ghc/$GHC_VER:$HOME/.cabal/$CABAL_VER:$PATH

before_install:
  - pip install --user awscli
  - echo $(which pip)
  - mkdir -p ~/$TRAVIS_BUILD_NUMBER
  - aws s3 sync s3://dotenv-releases/$TRAVIS_BUILD_NUMBER ~/$TRAVIS_BUILD_NUMBER

jobs:
  include:
    - stage: OS X build and test
      language: generic
      os: osx
      addons: skip
      before_install: sh .travis/ghcup.sh
      install: cabal install --only-dependencies --enable-tests
      script: cabal configure --enable-tests && cabal build && cabal test

    - stage: OS X binary build
      if: branch = master
      language: generic
      os: osx
      install: |
        sh .travis/ghcup.sh
        cabal install --only-dependencies
      script: sh .travis/travis_build.sh

    - stage: Linux static binary build
      if: branch = master
      ghc: 8.6
      script: sh .travis/travis_build.sh

    - stage: Deploy to GitHub
      language: generic
      before_deploy:
        - mv ~/$TRAVIS_BUILD_NUMBER/* $PWD
      deploy:
        provider: releases
        api_key: "$GITHUB_TRAVIS_DEPLOY"
        file:
          - "dotenv-linux-x86_64-static.tar.gz"
          - "dotenv-osx-x86_64-static.tar.gz"
        skip_cleanup: true
        release_notes_file: "CHANGELOG.md"
        edge: true
        draft: true
        on:
          tags: true
      after_deploy:
        - aws s3 rm --recursive s3://dotenv-releases/$TRAVIS_BUILD_NUMBER


after_success:
  - aws s3 sync ~/$TRAVIS_BUILD_NUMBER s3://dotenv-releases/$TRAVIS_BUILD_NUMBER
